<link rel="import" href="../../../polymer/polymer.html">
<link rel="import" href="../../../d2l-icons/tier1-icons.html">
<link rel="import" href="../d2l-organization-icons.html">
<link rel="import" href="../d2l-organization-behavior.html">
<link rel="import" href="localize-behavior.html">

<script>
	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	window.D2L.PolymerBehaviors.Organization = window.D2L.PolymerBehaviors.Organization || {};
	window.D2L.PolymerBehaviors.Organization.Updates = window.D2L.PolymerBehaviors.Organization.Updates || {};
	/*
	 *	Methods to get the information about organization updates.
	 * @polymerBehavior D2L.PolymerBehaviors.Organization.Updates.BehaviorImpl
	 */
	D2L.PolymerBehaviors.Organization.Updates.BehaviorImpl = {
		_organizationUpdates: {
			notificationMap: {
				UnreadAssignmentFeedback: {
					key: 'unreadAssignmentFeedback',
					presentationLink: 'ShowDropboxUnreadFeedback',
					toolTip: 'unreadAssignmentFeedback',
					icon: 'd2l-tier1:assignments',
					order: 1
				},
				UnreadAssignmentSubmissions: {
					key: 'unreadAssignmentFeedback',
					presentationLink: 'ShowUnreadDropboxSubmissions',
					toolTip: 'unreadAssignmentSubmissions',
					icon: 'd2l-tier1:assignments',
					order: 1
				},
				UnattemptedQuizzes: {
					key: 'unreadQuizzesFeedback',
					presentationLink: 'ShowUnattemptedQuizzes',
					toolTip: 'unattemptedQuizzes',
					icon: 'd2l-organization-icons:quiz-submissions',
					order: 3
				},
				UngradedQuizzes: {
					key: 'unreadQuizzesFeedback',
					presentationLink: 'ShowUngradedQuizAttempts',
					toolTip: 'ungradedQuizzes',
					icon: 'd2l-organization-icons:quiz-submissions',
					order: 3
				},
				UnreadDiscussions: {
					key: 'unreadDiscussionFeedback',
					presentationLink: 'ShowUnreadDiscussionMessages',
					toolTip: 'unreadDiscussions',
					icon: 'd2l-tier1:comment-hollow',
					order: 2
				},
				UnapprovedDiscussions: {
					key: 'unreadDiscussionFeedback',
					presentationLink: 'ShowUnreadDiscussionMessages',
					toolTip: 'unapprovedDiscussions',
					icon: 'd2l-tier1:comment-hollow',
					order: 2
				}
			}
		},
		_orgUpdates_fetch: function(notificationsUrl, presentationUrl) {
			if (!presentationUrl) {
				return Promise.resolve();
			}

			return this._fetchSirenEntity(presentationUrl)
				.then(function(presentation) {
					return presentation.properties || {};
				}.bind(this))
				.then(function(presentation) {
					return this._p_orgUpdates_fetchNotifications(notificationsUrl, presentation);
				}.bind(this));
		},
		_orgUpdates_notifications: function(notification, combined) {
			var maxCount = 99;
			if (combined) {
				notification = {
					updates: Object.keys(notification).reduce(function(accumulator, key) {
						return {
							updateCount: notification[key].updateCount + accumulator.updateCount,
							icon: null
						};
					}, { updateCount: 0 })
				};
			}

			return Object.keys(notification).map(function(key) {
				var toolTip = notification[key].toolTip
					? notification[key].toolTip.map(function(value) {
						return 	this.localize(value[0], 'number', value[1]);
					}.bind(this))
					: null;

				var element = {
					key: key,
					order: notification[key].order,
					isDisabled: (notification[key].updateCount <= 0),
					updateCount: (notification[key].updateCount > maxCount) ? maxCount + '+' : notification[key].updateCount,
					toolTip: toolTip,
					ariaLabel: this.localize(key, 'number', notification[key].updateCount),
					icon: notification[key].icon
				};
				return element;
			}.bind(this)).sort(function(a, b) {
				return a.order - b.order;
			});
		},
		_p_orgUpdates_fetchNotifications: function(notificationsUrl, presentation) {
			if (!notificationsUrl || !presentation) {
				return Promise.resolve();
			}

			return this._fetchSirenEntity(notificationsUrl)
				.then(function(notificationsInfo) {
					if (!(notificationsInfo = notificationsInfo.properties)) {
						return;
					}
					var notifications = {};
					for (var key in notificationsInfo) {
						if (notificationsInfo.hasOwnProperty(key)) {
							this._p_orgUpdates_prepareNotification(notifications, presentation, key, notificationsInfo[key]);
						}
					}

					return notifications;
				}.bind(this));
		},
		_p_orgUpdates_prepareNotification: function(notifications, presentation, notification, numberOfUpdates) {
			if (!this._organizationUpdates.notificationMap.hasOwnProperty(notification)) {
				return;
			}

			var options = this._organizationUpdates.notificationMap[notification];
			if (!options.key
				|| !options.presentationLink
				|| !presentation[options.presentationLink]
			) {
				return;
			}

			if (!notifications.hasOwnProperty(options.key)) {
				notifications[options.key] = {
					icon: options.icon,
					updateCount: 0,
					order: options.order,
					toolTip: []
				};
			}

			notifications[options.key].updateCount += numberOfUpdates;
			if (numberOfUpdates) {
				notifications[options.key].toolTip.push([options.toolTip, numberOfUpdates]);
			}
		},
	};

	/*
	* @polymerBehavior D2L.PolymerBehaviors.Organization.Updates.Behavior
	*/
	D2L.PolymerBehaviors.Organization.Updates.Behavior = [
		D2L.PolymerBehaviors.Organization.Updates.LocalizeBehavior,
		D2L.PolymerBehaviors.Organization.Behavior,
		D2L.PolymerBehaviors.Organization.Updates.BehaviorImpl
	];
</script>
